---
name: volumes-web-app
summary: Volumes Web App
description: |
  This web app is responsible for allowing the user to manipulate PVCs in their Kubeflow
  cluster. To achieve this it provides a user friendly way to handle the lifecycle of PVC
  objects.
version: "0.0.1"  # FIXME where do I get it from?
license: Apache-2.0
base: ubuntu:22.04  # TODO try with "bare"

services:
  serve:
    override: replace
    summary: "volumes service"
    command: gunicorn -w 3 --bind 0.0.0.0:5000 --access-logfile - entrypoint:app
    startup: enabled
    user: ubuntu
    environment:
      NODE_ENV: production
platforms:
  amd64:

parts:
  backend:
    plugin: nil
    source: https://github.com/kubeflow/kubeflow
    source-type: git
    source-tag: v1.7-branch  # upstream branch
    source-depth: 1
    build-packages:
      - python3-venv
      - python3-setuptools
      - python3-pip
    override-build: |
      python3 -m pip install wheel
      cd components/crud-web-apps/common/backend
      python3 setup.py bdist_wheel
      cp dist/kubeflow-1.1-py3-none-any.whl $CRAFT_STAGE

  frontend-lib:
    plugin: nil
    source: https://github.com/kubeflow/kubeflow
    source-type: git
    source-tag: v1.7-branch  # upstream branch
    source-depth: 1
    build-snaps:
      - node/12/stable
    build-environment:
      - NG_CLI_ANALYTICS: "ci"
    override-build: |
      cd components/crud-web-apps/common/frontend/kubeflow-common-lib
      npm ci
      npm run build
      cp -r dist/kubeflow/ $CRAFT_STAGE

  frontend:
    after: [frontend-lib]
    plugin: nil
    source: https://github.com/kubeflow/kubeflow
    source-type: git
    source-tag: v1.7-branch  # upstream branch
    source-depth: 1
    build-snaps:
      - node/12/stable
    build-environment:
      - NG_CLI_ANALYTICS: "ci"
    override-build: |
      cd components/crud-web-apps/volumes/frontend
      npm ci
      cp -r $CRAFT_STAGE/kubeflow/ ./node_modules/  # TODO confirm
      npm run build -- --output-path=./dist/default --configuration=production
      cp -r dist/default $CRAFT_STAGE

  webapp:
    after: [backend, frontend]  # TODO incorporate the "backend" part into this part?
    plugin: nil
    source: https://github.com/kubeflow/kubeflow
    source-type: git
    source-tag: v1.7-branch  # upstream branch
    source-depth: 1
    build-packages:
      - python3-venv
      - python3-setuptools
      - python3-pip
    override-build: |
      pip3 install $CRAFT_STAGE/kubeflow-1.1-py3-none-any.whl
      cd components/crud-web-apps/volumes/backend
      pip3 install -r requirements.txt
      cp -r $CRAFT_STAGE/default apps/default/static/
      cp -r apps $CRAFT_STAGE/
      cp entrypoint.py $CRAFT_STAGE
    # FIXME stage all the python packages installed in `override-build`
    override-stage: |
      cp -r apps $CRAFT_PRIME
      cp entrypoint.py $CRAFT_PRIME
#    stage-packages:
#      - python3-venv
#      # FIXME: with this `stage-packages`, rockcraft errors out with:
#      #        /root/stage/etc/alternatives: No such file or directory

  non-root-user:
    plugin: nil
    after: [webapp]
    overlay-script: |
      # Create a user in the $CRAFT_OVERLAY chroot
      groupadd -R $CRAFT_OVERLAY -g 1000 ubuntu
      useradd -R $CRAFT_OVERLAY -M -r -u 1000 -g ubuntu ubuntu
